{% extends "base.html" %}

{% block page_title %}Kontrol Paneli{% endblock %}

{% block content %}

<!-- Sayfa ÃœstÃ¼ Ã–zet KartlarÄ± -->
<div class="dashboard-grid">
    <!-- Hava Durumu -->
    <div class="card weather-widget" id="weather-section">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h3><i class="fa-solid fa-cloud-sun"></i> Hava Durumu</h3>
                <div id="weather-container" style="margin-top: 10px;">
                    <p class="loading-text">Veri alÄ±nÄ±yor...</p>
                </div>
            </div>
            <i class="fa-solid fa-sun" style="font-size: 3rem; opacity: 0.3;"></i>
        </div>
    </div>

    <!-- GÃ¼nlÃ¼k Durum -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h3><i class="fa-solid fa-chart-pie"></i> BugÃ¼n</h3>
                <div class="stat-value" id="status-label">0 L</div>
                <p id="streak-label" style="font-size: 0.9em; margin-top: 5px;">Hedef: YÃ¼kleniyor...</p>
            </div>
            <button id="reset-button" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;"
                title="SÄ±fÄ±rla">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
        </div>
        <div style="margin-top: 10px; height: 6px; background: #f1f5f9; border-radius: 10px; overflow: hidden;">
            <div id="progress-bar" style="height: 100%; width: 0%; background: var(--primary); transition: width 0.5s;">
            </div>
        </div>
    </div>

    <!-- AkÄ±llÄ± Ã–zet -->
    <div class="card">
        <h3><i class="fa-solid fa-wand-magic-sparkles"></i> AkÄ±llÄ± Analiz</h3>
        <div style="font-size: 0.95rem; color: var(--text-secondary);">
            <p id="summary-week-label">Veriler inceleniyor...</p>
            <p id="summary-category-label" style="margin-top: 5px; font-weight: 500;"></p>
        </div>
    </div>
</div>

<div class="grid-2">
    <!-- Sol Kolon: TÃ¼ketim Ekleme -->
    <!-- Sol Kolon: Hesaplama ve TÃ¼ketim -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">

        <!-- Fatura Ã‡Ã¶zÃ¼mleme (Ters Hesap) -->
        <div class="card">
            <h3><i class="fa-solid fa-calculator"></i> Faturadan TÃ¼ketim Bul</h3>
            <p>Fatura tutarÄ±nÄ± girin, tahmini su tÃ¼ketiminizi Ã¶ÄŸrenin ve kaydedin.</p>

            <div class="form-group">
                <label>Fatura TutarÄ± (TL)</label>
                <input type="number" id="calc-price" class="form-control" placeholder="Ã–rn: 520">
            </div>

            <div class="form-group">
                <label>Abone Tipi</label>
                <select id="calc-type-rev" class="form-control">
                    <option value="residential">Konut (Standart)</option>
                    <option value="student">Ã–ÄŸrenci (%50 Ä°ndirim)</option>
                    <option value="disabled">Engelli / Gazi (%50 Ä°ndirim)</option>
                </select>
            </div>

            <button onclick="calculateUsageFromPrice()" class="btn btn-secondary btn-block"
                style="background-color: var(--primary-light); color: var(--primary-dark); border:none;">
                <i class="fa-solid fa-search"></i> TÃ¼ketimi Bul
            </button>

            <div id="rev-result"
                style="margin-top:15px; display:none; border-top: 1px dashed var(--border); padding-top:10px;">
                <p>Tahmini TÃ¼ketim:</p>
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);" id="rev-usage">0 mÂ³</div>
                <div style="font-size: 0.9rem; color: var(--text-secondary);" id="rev-liters">0 Litre</div>

                <button onclick="addCalculatedUsage()" class="btn btn-primary btn-block" style="margin-top:10px;">
                    <i class="fa-solid fa-plus"></i> Bunu TÃ¼ketimime Ekle
                </button>
            </div>
        </div>

        <!-- TÃ¼ketim Ekleme -->
        <div class="card">
            <h3><i class="fa-solid fa-plus-circle"></i> TÃ¼ketim Ekle</h3>
            <div class="form-group">
                <label for="category-select">Aktivite TÃ¼rÃ¼</label>
                <select id="category-select" class="form-control">
                    <option value="shower">DuÅŸ (Dakika)</option>
                    <option value="dishwasher">BulaÅŸÄ±k Makinesi (YÄ±kama)</option>
                    <option value="washing_machine">Ã‡amaÅŸÄ±r Makinesi (YÄ±kama)</option>
                    <option value="tap">Musluk KullanÄ±mÄ± (Dakika)</option>
                    <option value="garden">BahÃ§e Sulama (Dakika)</option>
                    <option value="car_wash">AraÃ§ YÄ±kama (YÄ±kama)</option>
                    <option value="custom">DiÄŸer / Manuel (Litre)</option>
                </select>
            </div>

            <!-- Makine Modu SeÃ§imi (Gizli) -->
            <div class="form-group" id="model-selection-group"
                style="display: none; background: #f0f9ff; padding: 10px; border-radius: 8px; border: 1px solid #bae6fd;">
                <label for="model-select" style="color: #0369a1;"><i class="fa-solid fa-list-check"></i> Program /
                    Verimlilik Modu</label>
                <select id="model-select" class="form-control" style="border-color: #7dd3fc;">
                    <!-- JS ile doldurulacak -->
                </select>
            </div>

            <div class="form-group">
                <label for="liters-entry" id="amount-label">SÃ¼re (Dakika)</label>
                <input type="number" id="liters-entry" class="form-control" placeholder="DeÄŸer girin...">
            </div>
            <button id="add-button" class="btn btn-primary btn-block">
                <i class="fa-solid fa-save"></i> Kaydet
            </button>
        </div>

        <!-- Fatura Analizi (MODEL KISMI) -->
        <div class="card" style="border: 2px dashed var(--primary); background-color: var(--primary-light);">
            <h3><i class="fa-solid fa-camera"></i> Yapay Zeka ile Fatura Oku</h3>
            <p style="font-size: 0.9rem;">Su faturanÄ±zÄ±n fotoÄŸrafÄ±nÄ± yÃ¼kleyin, sistem otomatik olarak tÃ¼ketimi okusun.
            </p>
            <input type="file" id="bill-input" accept="image/*" class="form-control"
                style="margin-top: 10px; background: white;">
            <button id="analyze-btn" onclick="faturaAnalizEt()" class="btn btn-primary btn-block"
                style="margin-top: 15px;">
                <i class="fa-solid fa-robot"></i> FaturayÄ± Analiz Et
            </button>
            <div id="analysis-result" style="margin-top: 15px; font-weight: 600;"></div>
        </div>
    </div>

    <!-- SaÄŸ Kolon: Rapor ve Grafikler -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div class="card" id="report-card-content" style="flex: 1;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">TÃ¼ketim GrafiÄŸi</h3>
                <div style="display: flex; gap: 5px;">
                    <button class="btn btn-secondary btn-sm" onclick="changePeriod('daily')">GÃ¼n</button>
                    <button class="btn btn-secondary btn-sm" onclick="changePeriod('weekly')">Hafta</button>
                    <button class="btn btn-secondary btn-sm" onclick="changePeriod('monthly')">Ay</button>
                </div>
            </div>

            <div style="height: 300px;">
                <canvas id="dailyTrendChart"></canvas>
            </div>

            <div style="margin-top: 30px; height: 250px;">
                <h4 style="text-align: center; margin-bottom: 15px;">Kategori DaÄŸÄ±lÄ±mÄ±</h4>
                <canvas id="categoryPieChart"></canvas>
            </div>

        </div>

        <!-- YENÄ°: Fatura GeÃ§miÅŸi AlanÄ± -->
        <div class="card" style="margin-top: 30px;">
            <h4 style="text-align: center; margin-bottom: 15px;"><i class="fa-solid fa-file-invoice"></i> AylÄ±k Fatura
                GeÃ§miÅŸi</h4>
            <div id="bill-history-container" style="overflow-x: auto;">
                <table class="table" style="width: 100%; text-align: left; font-size: 0.9rem;">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Miktar</th>
                            <th>Litre</th>
                            <th>Ä°ÅŸlem</th>
                        </tr>
                    </thead>
                    <tbody id="bill-history-body">
                        <tr>
                            <td colspan="3" style="text-align:center;">YÃ¼kleniyor...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <button onclick="downloadReport()" class="btn btn-secondary btn-block" style="margin-top: 20px;">
            <i class="fa-solid fa-download"></i> Raporu Ä°ndir
        </button>
    </div>

    <!-- Hedef AyarÄ± -->
    <div class="card">
        <h3><i class="fa-solid fa-bullseye"></i> GÃ¼nlÃ¼k Hedef</h3>
        <div style="display: flex; gap: 10px; align-items: flex-end;">
            <div style="flex: 1;">
                <label style="font-size: 0.85rem;">Hedef (Litre)</label>
                <input type="number" id="target-entry" class="form-control" placeholder="150">
            </div>
            <button id="target-button" class="btn btn-primary">GÃ¼ncelle</button>
        </div>
    </div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="/static/app.js"></script>

<script>
    // --- Ä°Ã‡ SAYFA SCRIPTLERI ---

    // 1. FATURA ANALÄ°Z (MODEL)
    async function faturaAnalizEt() {
        const fileInput = document.getElementById('bill-input');
        const resultDiv = document.getElementById('analysis-result');
        const btn = document.getElementById('analyze-btn');

        if (!fileInput.files || fileInput.files.length === 0) {
            Swal.fire({ icon: 'warning', title: 'Dosya SeÃ§ilmedi', text: 'LÃ¼tfen fatura fotoÄŸrafÄ±nÄ± seÃ§in.' });
            return;
        }

        btn.disabled = true; btn.innerHTML = 'â³ Analiz Ediliyor...';
        resultDiv.innerText = "Yapay zeka faturayÄ± okuyor...";
        resultDiv.style.color = "var(--primary)";

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const response = await fetch('/api/analyze_bill', { method: 'POST', body: formData });
            const data = await response.json();

            if (data.success) {
                Swal.fire({
                    title: data.advice_title, icon: 'success',
                    html: `<div style="text-align:left;">
                    <p>ğŸ§¾ Okunan: <strong>${data.message}</strong></p>
                    <p>ğŸ’§ Toplam: ${data.liters.toLocaleString()} L</p>
                    <p>ğŸ“Š GÃ¼nlÃ¼k Ort: ${data.daily_avg.toFixed(0)} L</p>
                    <p class="mt-2 text-muted">"${data.advice_text}"</p></div>`,
                    confirmButtonText: 'Kaydet', confirmButtonColor: '#0ea5e9'
                }).then((res) => {
                    if (res.isConfirmed) {
                        // FaturayÄ± 'bill' aktivitesi olarak sunucuya gÃ¶nder
                        const payload = {
                            activity: 'bill',
                            amount: data.liters
                        };

                        fetch('/api/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                            .then(r => r.json())
                            .then(result => {
                                if (result.success) {
                                    Swal.fire('Kaydedildi', 'Fatura verisi "Fatura GeÃ§miÅŸi" altÄ±na eklendi.', 'success');
                                    // SayfayÄ± yenilemeden gÃ¼ncellemeleri tetikle (global fonksiyonlar varsa)
                                    if (window.updateCharts) window.updateCharts();
                                    if (window.updateStatus) window.updateStatus();
                                    location.reload();
                                } else {
                                    Swal.fire('Hata', result.message, 'error');
                                }
                            });
                    }
                });
                resultDiv.innerText = "âœ… BaÅŸarÄ±lÄ±!"; resultDiv.style.color = "var(--success)";
            } else {
                Swal.fire({ icon: 'error', title: 'OkunamadÄ±', text: data.message });
                resultDiv.innerText = "âŒ " + data.message; resultDiv.style.color = "var(--danger)";
            }
        } catch (error) {
            console.error(error);
            resultDiv.innerText = "âŒ Hata";
        } finally {
            btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-robot"></i> FaturayÄ± Analiz Et';
        }
    }

    // 2. RAPOR Ä°NDÄ°RME
    function downloadReport() {
        const reportCard = document.getElementById('report-card-content');
        html2canvas(reportCard).then(canvas => {
            const link = document.createElement('a');
            link.download = 'waterwise_rapor.png';
            link.href = canvas.toDataURL();
            link.click();

            Swal.fire({
                icon: 'success',
                title: 'Ä°ndirildi',
                timer: 1500,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
        });
    }

    // 3. HAVA DURUMU BAÅLATMA
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/weather_advice').then(r => r.json()).then(d => {
            const div = document.getElementById('weather-container');
            if (d.temp != "-") {
                div.innerHTML = `<div style="font-size:1.5rem; font-weight:bold;">${d.temp}Â°C</div><div>${d.city}</div><div style="font-size:0.9rem; margin-top:5px; opacity:0.9;">${d.advice}</div>`;
            } else {
                div.innerHTML = "Bilgi alÄ±namadÄ±";
            }
        }).catch(console.error);
    });
</script>
{% endblock %}